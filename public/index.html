<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

        <title>SiGML Play test</title>

        <link rel="stylesheet" href="jas/loc2022/cwa/cwasa.css" />
        <script type="text/javascript" src="jas/loc2022/cwa/allcsa.js"></script>
        <script language="javascript">
            // Initial configuration
            var initCfg = {
                avsbsl: ["anna", "francoise", "luna", "marc", "siggi"],
                avSettings: { avList: "avsbsl", initAv: "luna" },
            };
        </script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Rubik&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="css/index.css" />
    </head>

    <body>
        <div class="container">
            <div class="controlls">
                <center><p class="heading">Text to ISL Converter</p></center>
                <input
                    type="button"
                    value="Play SiGML Text"
                    class="bttnPlaySiGMLText av0"
                    style="display: none"
                />
                <!-- <span class="CWASASpeed av0"></span> -->
                <!-- <input type="button" value="Suspend" class="bttnSuspend av0" disabled="">
                <input type="button" value="Resume" class="bttnResume av0" disabled="">
                Frames:
                <input type="button" value="-1" class="bttnPrevF av0" disabled="">
                <input type="button" value="+1" class="bttnNextF av0" disabled="">
                </span> -->
                <label for="menu">Avatar: &emsp;</label>
                <span class="CWASAAvMenu av0" id="menu"></span>
                <!-- <span class="spanSpeed av0">
                    Speed :
                    <input type="text" class="txtLogSpeed av0" value="+1.0" />
                    <input type="button" value="-" class="bttnSpeedDown av0" />
                    <input type="button" value="+" class="bttnSpeedUp av0" />
                    <input
                        type="button"
                        value="Reset"
                        class="bttnSpeedReset av0"
                        disabled=""
                    />
                </span> -->
                <br /><br /><br />
                <label for="textInp">Enter the Text: &emsp;</label>
                <textarea
                    name=""
                    id="textInp"
                    cols="30"
                    rows="5"
                    placeholder="Enter text"
                ></textarea
                ><br /><br /><br />
                <input
                    type="text"
                    id="URLText"
                    class="txtaSiGMLText av0"
                    value=""
                    style="display: none"
                />

                <center>
                    <input
                        class="btn play"
                        type="button"
                        value="Play"
                        onclick="stemAndPlay();"
                    />&emsp;
                    <input
                        type="button"
                        value="Stop"
                        class="bttnStop av0 btn stop"
                    />
                </center>
                <br />

                <br />
            </div>
            <div class="avatarContainer">
                <div class="CWASAAvatar av0" align="center"></div>
                <div class="textContainer"></div>
            </div>
        </div>
        <script>
            CWASA.init(initCfg);
            const textContainer = document.querySelector(".textContainer");
            const textInp = document.getElementById("textInp");
            const SiGMLTextElement = document.querySelector(".txtaSiGMLText");
            const bttnPlaySiGMLTextElement =
                document.querySelector(".bttnPlaySiGMLText");

            function stemAndPlay() {
                const text = textInp.value.trim();
                if (!text) return;
                document.querySelector(".play").disabled = true;
                fetch(
                    "/api/sign?" + new URLSearchParams({ q: text }).toString()
                )
                    .then((res) => res.json())
                    .then((data) => {
                        console.log(data);
                        textContainer.innerHTML = "";
                        let currId = 0;
                        for (const symbol of data.symbols) {
                            if (Array.isArray(symbol)) {
                                const parent = document.createElement("span");
                                parent.classList.add("symbol");
                                for (letter of symbol) {
                                    const span = document.createElement("span");
                                    span.innerText = letter;
                                    span.setAttribute("id", `symbol-${currId}`);
                                    parent.appendChild(span);
                                    currId++;
                                }
                                textContainer.appendChild(parent);
                            } else {
                                const span = document.createElement("span");
                                span.innerText = symbol;
                                span.classList.add("symbol");
                                span.setAttribute("id", `symbol-${currId}`);
                                textContainer.appendChild(span);
                                currId++;
                            }
                        }

                        SiGMLTextElement.value = data.sigml;
                        bttnPlaySiGMLTextElement.click();
                        document.querySelector(".play").disabled = false;
                    })
                    .catch((err) => {
                        window.alert("Something went wrong!...");
                        console.error(err);
                        document.querySelector(".play").disabled = false;
                    });
            }
            CWASA.addHook("avatarsign", (e) => {
                // {typ: "avatarsign", msg: {g: 'your', f: 1, s: 0}, av: 0}
                document
                    .querySelector(`#symbol-${e.msg.s}`)
                    .classList.toggle("highlight", true);
                if (e.msg.s > 0) {
                    document
                        .querySelector(`#symbol-${e.msg.s - 1}`)
                        .classList.toggle("highlight", false);
                }
            });
            // Output
        </script>
    </body>
</html>
